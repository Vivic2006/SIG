WITH Doublons AS (
    SELECT
        ID_DEVIS,
        MT_NETHT_DEVIS,
        COUNT(*) OVER (PARTITION BY ID_DEVIS) AS nombre_de_doublons
    FROM
        [dwh].[F_DEVIS]
    WHERE
        ID_ENSEIGNE = (SELECT ID_ENSEIGNE FROM [dwh].[REF_ENSEIGNE] WHERE CODE_ENSEIGNE = 'LIT')
        AND ID_CALENDRIER IN (SELECT ID_CALENDRIER FROM [dwh].[D_CALENDRIER] WHERE YEAR(DATE_JOUR) > YEAR(GETDATE()) - (1 + 2) AND DATE_JOUR <= GETDATE())
        AND FLG_SUPPRESSION = 'N'
)
SELECT
    d.ID_DEVIS,
    d.[MT_NETHT_DEVIS],
    CASE
        WHEN d.nombre_de_doublons > 1 THEN d.[MT_NETHT_DEVIS] / d.nombre_de_doublons
        ELSE d.[MT_NETHT_DEVIS]
    END AS MT_NETHT_AJUSTE,
    -- Ajoutez d'autres colonnes nécessaires à votre vue
FROM
    Doublons d
    INNER JOIN [dwh].[F_DEVIS] f
    ON d.ID_DEVIS = f.ID_DEVIS
    INNER JOIN [dwh].[REF_NEUF_RENOVATION_DEVIS] rnrd
    ON f.[ID_NEUF_RENOVATION_DEVIS] = rnrd.[ID_NEUF_RENOVATION_DEVIS]
    INNER JOIN [dwh].[REF_NATURE_DEVIS] rnd
    ON f.ID_NATURE_DEVIS = rnd.ID_NATURE_DEVIS
    INNER JOIN [dwh].[REF_TYPE_LIGNE_DEVIS] tld
    ON f.ID_TYPE_LIGNE_DEVIS = tld.ID_TYPE_LIGNE_DEVIS
    INNER JOIN [dwh].[D_CLIENT] c
    ON f.ID_CLIENT = c.ID_CLIENT
WHERE
    d.ID_ENSEIGNE = (SELECT ID_ENSEIGNE FROM [dwh].[REF_ENSEIGNE] WHERE CODE_ENSEIGNE = 'LIT')
    AND d.ID_CALENDRIER IN (SELECT ID_CALENDRIER FROM [dwh].[D_CALENDRIER] WHERE YEAR(DATE_JOUR) > YEAR(GETDATE()) - (1 + 2) AND DATE_JOUR <= GETDATE())
    AND d.FLG_SUPPRESSION = 'N';
